import requests
import os

# 요청 URL
url = 'https://mb-api.abuse.ch/api/v1/'


# normal request hash 기반 검색
normal_request = {
    'query': 'get_info',
    'hash': '7de2c1bf58bce09eecc70476747d88a26163c3d6bb1d85235c24a558d1f16754'
}

# sig request APT 그룹 시그니쳐 기반 검색
sig_request = {
    'query': 'get_siginfo',
    'signature': 'lazarus', # APT 그룹명
    'limit': 200 # 전체 데이터(all), 50개 데이터(default)
}

# Fiddler HTTP 프록시 설정
proxies = {
    'http': 'http://127.0.0.1:8888',
}

try:
    # HTTP 프록시를 통해 POST 요청 보내기
    response = requests.post(url, data=sig_request, proxies=proxies, verify=False)
    
    # 응답 데이터를 result.json 파일에 저장
    if(response.status_code != 200):
        print(f"Error: {response.status_code}")
        print(f"Response: {response.text}")

    else:
        # data 필드에서 필요한 키값 추출
        data = response.json()
        data_list = data.get('data', [])
        # print(data_list) ok
        if not data_list:
            print("Error: No data found in the response")
        else:
            # 필터링할 필드 목록
            fields_to_extract = [
                'sha256_hash', 'sha1_hash', 'md5_hash', 'first_seen', 'last_seen',
                'file_name', 'file_size', 'file_type', 'file_type_mime', 'signature',
                'tags', 'code_sign', 'intelligence'
            ]

            # 추출된 데이터를 저장할 리스트
            filtered_data_list = []

            # 각 데이터 항목에 대해 필요한 필드 추출
            for item in data_list:
                filtered_item = {key: item.get(key) for key in fields_to_extract}
                filtered_data_list.append(filtered_item)
                print(filtered_data_list)
            
            with open('result.json', 'w') as file:
                file.write(filtered_data_list.__str__())
            print(f"{os.getcwd()}에 저장되었습니다.")

except requests.exceptions.RequestException as e:
    print(f"RequestException: {e}")


    
